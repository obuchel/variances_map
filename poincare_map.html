<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Style circles with a data-driven property</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.5.0/d3.js"></script>

<style>
	body { margin: 0; padding: 0; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }


#plot {  background-color: #F0F0F0; visibility:hidden; /*z-index:100000000;*/}
.map-overlay {
  position: absolute;
  bottom: 0;
  right: 0;
  background: rgba(255, 255, 255, 0.8);
  margin-right: 20px;
/*z-index:100000000;*/
  overflow: auto;
  border-radius: 3px;
  width: 320; 
height:35% !important;

}
    .map-overlay1 {
  position: absolute;
  bottom: 0;
  right: 0;
  background: rgba(255, 255, 255, 0.8);
  margin-right: 20px;

  overflow: auto;
  border-radius: 3px;
  width: 320; 
height:28% !important;

}
    
    #features {
  top: 0;
  height: 100px;
  margin-top: 20px;
  width: 320px;
        visibility:hidden
}



	
     #legend {
        padding: 10px;
       /* box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);*/
        line-height: 15px;
       /* height: 80px;*/
        margin-bottom: 20px;
        width: 30%;
         height:28% !important;
      /*   z-index:100000000;*/
        
      }
      .legend-key {
        display: inline-block;

        width: 10px;
        height: 10px;
        margin-right: 5px;
          /*font-size: 12% !important;*/
      }
 .mapbox-improve-map {
     display: none !important;
 }
 .mapboxgl-ctrl-compass { display: none !important; }~

	
</style>
</head>
<body>
  <div id="map"></div>
  <div class="map-overlay" id="features">
    <div id="plot"></div>
    </div>
<script>
	mapboxgl.accessToken = 'pk.eyJ1Ijoib2J1Y2hlbCIsImEiOiJjanlrY3diNzIwZDdxM25uN2owN2c5ZHpiIn0.XzMbcbHF6H42u0Uxo1L8lg';
var map = new mapboxgl.Map({
container: 'map',
style: 'mapbox://styles/mapbox/dark-v9',
zoom: 3,
center: [-92.447303, 40.753574]
});
 
map.on('load', function () {
/* Sample feature from the `examples.8fgz4egr` tileset:
{
"type": "Feature",
"properties": {
"ethnicity": "White"
},
"geometry": {
"type": "Point",
"coordinates": [ -122.447303, 37.753574 ]
}
}
*/
map.addSource('ethnicity', {
type: 'geojson',
data: 'poincare.json'
});
    //http://ec2-35-153-102-199.compute-1.amazonaws.com/elastic/
    /*
#e31a1c
#bd0026
#800026 [1, '#fed976'][100, '#fd8d3c'],[1000, '#e31a1c'],[10000, '#800026']
*/
    var arr=[[-1, '#000000'],[0, '#fed976'],[10, '#fed976'],[20, '#1a9850'],[50,'#800026']];       
map.addLayer({
'id': 'population',
'type': 'circle',
'source': 'ethnicity',
//'source-layer': 'sf2010',
'paint': {
    'circle-radius':2
    /*{
'base': 1.75,
'stops': [
[18, 2],
[22, 180]
]
}*/,
'circle-color': {
property: "sd1",
stops: arr
},
    
'circle-opacity': 1
}
});
map.on('click', 'population', function (e) {
var coordinates = e.features[0].geometry.coordinates.slice();
var description = "<b>"+e.features[0].properties.geoid+"</b> <br><b>sd1</b>:"+e.features[0].properties.sd1+" <br><b>sd2</b>:"+e.features[0].properties.sd2+" <br><b>ellipse_area</b>"+e.features[0].properties.ellipse_area+" <br><b>sd_ratio</b>:"+e.features[0].properties.sd_ratio;
 
// Ensure that if the map is zoomed out such that multiple
// copies of the feature are visible, the popup appears
// over the copy being pointed to.
while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
}

    if (e.features[0].properties.geoid.toString().split(".")[0].length<12) {
	var nn="0"+e.features[0].properties.geoid.toString().substr(0,1);
	var nn1='0'+e.features[0].properties.geoid.toString().substr(0,3);
	var nn2="0";
    } else {
var nn=e.features[0].properties.geoid.toString().substr(0,2);
	var nn1=e.features[0].properties.geoid.toString().substr(0,4);
	var nn2="";
    }


    
   // alert(e.features[0].properties.geoid.toString().substr(0,2));
    var url="https://obuchel.github.io/variances_map/"+nn+'/'+nn1+'/'+nn2+e.features[0].properties.geoid.toString().split(".")[0]+'.csv';
    //console.log(url);
    d3.csv(url, function(error,data7) {

	//console.log(error,data7);
        draw_plot(data7,"grey");
new mapboxgl.Popup()
.setLngLat(coordinates)
.setHTML(description)
.addTo(map);
});
});
});
function draw_plot(data,color) {
    d3.select("#plot").html("");    
    
   //console.log(data);
    document.getElementById("plot").style.visibility="visible";
   document.getElementById("features").style.visibility="visible";
   // console.log(data);
   // console.log(data["dates"][0].split("/"));
    //"original_values", time, dates
    var data110=[];
//    console.log(data["Date"]);
    for (var i=0; i<data.length; i++) {
        if (Number(data[i]["number"])>=0){
            var val=Number(data[i]["number"]);
            
            
            var temp={"date":new Date(Number(data[i]["Date"].split("-")[0]),Number(data[i]["Date"].split("-")[2])-1,Number(data[i]["Date"].split("-")[1])),"value":val};
        data110.push(temp);
        } else {
            //var val=0;
        }
        
    }
    /*
 var data10=[];
    console.log(data["time"]);
    for (var i=1; i<data["time"].length; i++) {
        if (data["original_values"][i]>=0){
            var val=data["original_values"][i];
            var temp={"date":new Date(Number(data["time"][i].split("-")[2]),Number(data["time"][i].split("-")[1])-1,Number(data["time"][i].split("-")[0])),"value":val};
        data10.push(temp);
        } else {
            var val=0;
        }
        
    }*/
   //console.log(data110.map(function(d){ return d.value}),data10.map(function(d){ return d.value}));
    var margin = {top: 25, right: 20, bottom: 20, left: 35},
    width = 300 - margin.left - margin.right,
    height = window.innerHeight*0.3 - margin.top - margin.bottom;
    
    var svg = d3.select("#plot")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");
d3.select(".map-overlay").attr("height",Number(height)+" !important");
    var defs = svg.append("defs");


var dropShadowFilter = defs.append('svg:filter')
  .attr('id', 'drop-shadow')
  .attr('filterUnits', "userSpaceOnUse")
  .attr('width', '250%')
  .attr('height', '250%');
dropShadowFilter.append('svg:feGaussianBlur')
  .attr('in', 'SourceGraphic')
  .attr('stdDeviation', 2)
  .attr('result', 'blur-out');
dropShadowFilter.append('svg:feColorMatrix')
  .attr('in', 'blur-out')
  .attr('type', 'hueRotate')
  .attr('values', 180)
  .attr('result', 'color-out');
dropShadowFilter.append('svg:feOffset')
  .attr('in', 'color-out')
  .attr('dx', 3)
  .attr('dy', 3)
  .attr('result', 'the-shadow');
dropShadowFilter.append('svg:feBlend')
  .attr('in', 'SourceGraphic')
  .attr('in2', 'the-shadow')
  .attr('mode', 'normal');
    
    // Add X axis --> it is a date format
    var x = d3.scaleTime()
      .domain(d3.extent(data110, function(d) { return d.date; }))
      .range([ 0, width ]);
    svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x).ticks(5).tickFormat(function(date){
             return d3.timeFormat('%b')(date);
      }));

    // Add Y axis
    var y = d3.scaleLinear()
      .domain([0,d3.max(data110, function(d) { return +d.value; })])
      .range([ height, 0]);
    svg.append("g")
      .call(d3.axisLeft(y).ticks(5));

    
  /*
      var path1 = svg.append("path")
      .datum(data10)
      .attr("fill", "none")
      .attr("stroke", "grey")
      .attr("stroke-width", 0.5)
      .attr("d", d3.line()
        .x(function(d) { return x(d.date) })
        .y(function(d) { return y(d.value) })
            //.curve(d3.curveNatural)
        );
       // .style("filter", "url(#drop-shadow)");
  */
// Add the line
      var path = svg.append("path")
      .datum(data110)

      .attr("fill", "none")
      .attr("stroke", color)
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(function(d) { return x(d.date) })
        .y(function(d) { return y(d.value) })
           // .curve(d3.curveNatural)
        );
       // .style("filter", "url(#drop-shadow)");
    
    var curtain = svg.append('rect')
 .attr('x', -1 * width)
 .attr('y', -1 * height)
 .attr('height', height+20)
 .attr('width', width-2)
 .attr('class', 'curtain')
 .attr('transform', 'rotate(180)')
 .style('fill', '#F0F0F0')
        
  curtain.transition()
 .duration(1500)
 //.ease("linear")
 .attr('x', -2 * width)
            
            /*
        svg.append("text")
        .attr("x", (width / 2))             
        .attr("y", 1)
        .attr("text-anchor", "middle")  
        .style("font-size", "14px") 
       //.style("text-decoration", "underline")  
        .text("Last two weeks: "+d3.format(',')(data["max_14"]));
    
      svg.append("text")
        .attr("x", (width / 2))             
        .attr("y", 15)
        .attr("text-anchor", "middle")  
        .style("font-size", "14px") 
       //.style("text-decoration", "underline")  
        .text("Total: "+d3.format(',')(data["max"]));
    */
   /* console.log(d3.selectAll(".tick").each(function(d) {
        
        console.log(d3.select(d)._groups);
       
    }));*/
             
    }

  
</script>
 
</body>
</html>
